import pool from '../../../utils/db.js';

export default async function handler(req, res) {
  const { alias, secret } = req.query;

  if (!alias || !secret) {
    return res.status(400).end('Missing alias or secret');
  }

  try {
    const client = await pool.connect();
    const linkRes = await client.query(
      `SELECT click_count FROM links WHERE alias = $1 AND secret = $2`,
      [alias, secret]
    );

    if (linkRes.rows.length === 0) {
      client.release();
      return res.status(403).end('Invalid secret');
    }

    const clicksRes = await client.query(
      `SELECT country, device, created_at 
       FROM clicks 
       WHERE link_id = (SELECT id FROM links WHERE alias = $1)
       ORDER BY created_at DESC
       LIMIT 20`,
      [alias]
    );
    client.release();

    res.setHeader('Content-Type', 'application/json');
    res.end(JSON.stringify({
      total: linkRes.rows[0].click_count,
      recent: clicksRes.rows
    }));
  } catch (e) {
    res.status(500).end();
  }
}