import pool from '../utils/db.js';
import { getCountry, getDevice } from '../utils/geo.js';

export default async function handler(req, res) {
  const { alias } = req.query;
  const ip = req.headers['x-forwarded-for']?.split(',')[0] || req.socket.remoteAddress;
  const ua = req.headers['user-agent'];

  try {
    const client = await pool.connect();
    const linkRes = await client.query(
      'SELECT id, target_url FROM links WHERE alias = $1',
      [alias]
    );

    if (linkRes.rows.length === 0) {
      client.release();
      return res.status(404).end();
    }

    const { id, target_url } = linkRes.rows[0];

    // Определяем страну и устройство
    const country = await getCountry(ip);
    const device = getDevice(ua);

    // Обновляем счётчик и логируем клик
    await client.query('UPDATE links SET click_count = click_count + 1 WHERE id = $1', [id]);
    await client.query('INSERT INTO clicks (link_id, country, device) VALUES ($1, $2, $3)', [id, country, device]);

    client.release();
    res.redirect(302, target_url);
  } catch (e) {
    res.status(500).end();
  }
}